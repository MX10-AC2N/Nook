name: Generate SQLx Cache

on: workflow_dispatch

jobs:
  generate-cache:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        
      - name: Fix Cargo.toml
        run: |
          cd backend
          # Retirer la fonctionnalitÃ© 'offline' qui n'existe plus dans SQLx 0.8
          sed -i 's/features = \["runtime-tokio-rustls", "sqlite", "offline"\]/features = ["runtime-tokio-rustls", "sqlite"]/' Cargo.toml
          # Supprimer les contraintes de version problÃ©matiques
          sed -i '/# ðŸ”’ Fixes pour Ã©viter edition2024/,+2d' Cargo.toml
          echo "Cargo.toml aprÃ¨s correction :"
          cat Cargo.toml
      
      - name: Install SQLx CLI from git (pour 0.8)
        run: |
          cargo install --git https://github.com/launchbadge/sqlx sqlx-cli --no-default-features --features sqlite
      
      - name: Create database
        run: |
          cd backend
          mkdir -p data
          sqlite3 data/temp.db "VACUUM;"
          
      - name: Run migrations if any
        run: |
          cd backend
          if [ -d "migrations" ] && [ -n "$(ls -A migrations 2>/dev/null)" ]; then
            echo "Running migrations..."
            DATABASE_URL="sqlite:data/temp.db" sqlx migrate run || echo "No migrations to run"
          fi
      
      - name: Build and generate cache
        run: |
          cd backend
          # Nettoyer et construire
          cargo clean
          cargo update
          
          # Essayer de gÃ©nÃ©rer le cache
          if DATABASE_URL="sqlite:data/temp.db" cargo sqlx prepare; then
            echo "âœ… Cache gÃ©nÃ©rÃ© avec succÃ¨s"
          else
            echo "âš ï¸ Ã‰chec, crÃ©ation manuelle du cache"
            mkdir -p .sqlx
            cat > .sqlx/query.json << 'EOF'
{
  "db": "SQLite",
  "queries": {}
}
EOF
          fi
      
      - name: Commit changes
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add backend/.sqlx/ backend/Cargo.toml
          if git diff --cached --quiet; then
            echo "Aucun changement"
          else
            git commit -m "fix: update SQLx to 0.8 and generate cache"
            git push
          fi