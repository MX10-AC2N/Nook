name: Debug SQLx Cache

on: workflow_dispatch

jobs:
  debug:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        run: rustup update stable && rustup default stable
      
      - name: Install SQLx CLI
        run: cargo install sqlx-cli --version 0.7.3 --features sqlite
      
      - name: Check backend structure
        run: |
          cd backend
          echo "=== Fichiers dans backend/ ==="
          ls -la
          echo ""
          echo "=== Cargo.toml ==="
          cat Cargo.toml
          echo ""
          echo "=== Existe-t-il des fichiers .rs ? ==="
          find . -name "*.rs" | head -10
          echo ""
          echo "=== Vérification de sqlx dans Cargo.toml ==="
          if grep -q "sqlx" Cargo.toml; then
            echo "✅ sqlx trouvé dans les dépendances"
          else
            echo "❌ sqlx NON trouvé dans les dépendances"
          fi
      
      - name: Try cargo sqlx prepare
        run: |
          cd backend
          mkdir -p data
          touch data/temp.db
          
          echo "=== Test de cargo metadata ==="
          cargo metadata --format-version=1 > metadata.json 2>&1 && echo "✅ cargo metadata OK" || echo "❌ cargo metadata échoué"
          
          echo "=== Test de cargo sqlx prepare ==="
          DATABASE_URL="sqlite:data/temp.db" cargo sqlx prepare --verbose 2>&1 | tail -50