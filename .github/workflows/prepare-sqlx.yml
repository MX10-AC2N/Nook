name: Generate SQLx Cache

on: workflow_dispatch

jobs:
  sqlx-cache:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup diagnostics
        run: |
          cd backend
          echo "=== Diagnostic du système ==="
          rustc --version
          cargo --version
          sqlx --version || echo "SQLx CLI non installé"
          echo "=== Structure du projet ==="
          find . -name "*.rs" | head -10
          echo "=== Cargo.toml ==="
          cat Cargo.toml
        
      - name: Install SQLx CLI via cargo-binstall
        run: |
          # Utiliser cargo-binstall pour une installation plus fiable
          curl -L --proto '=https' --tlsv1.2 -sSf https://raw.githubusercontent.com/cargo-bins/cargo-binstall/main/install-from-binstall-release.sh | bash
          cargo binstall sqlx-cli --no-confirm --features sqlite
        
      - name: Build project first
        run: |
          cd backend
          # Builder le projet pour résoudre les dépendances
          cargo build --release 2>&1 | tail -50
          # Ou avec check
          cargo check --features sqlite
        
      - name: Create minimal setup
        run: |
          cd backend
          mkdir -p data
          # Créer un fichier de migration minimal
          if [ ! -f "migrations/0001_init.sql" ]; then
            mkdir -p migrations
            cat > migrations/0001_init.sql << 'EOF'
CREATE TABLE IF NOT EXISTS users (
    id INTEGER PRIMARY KEY,
    name TEXT NOT NULL
);
INSERT OR IGNORE INTO users (id, name) VALUES (1, 'test');
EOF
          fi
        
      - name: Run migrations
        run: |
          cd backend
          DATABASE_URL="sqlite:data/temp.db" sqlx migrate run
        
      - name: Generate cache with retry
        run: |
          cd backend
          # Essayer plusieurs fois
          for i in {1..3}; do
            echo "Tentative $i..."
            if DATABASE_URL="sqlite:data/temp.db" cargo sqlx prepare; then
              echo "Succès à la tentative $i"
              break
            fi
            sleep 2
          done
        
      - name: Final verification
        run: |
          cd backend
          if [ -f ".sqlx/query.json" ] || [ -f ".sqlx/query-*.json" ]; then
            echo "✅ Cache SQLx généré"
            find .sqlx -type f | xargs wc -l
          else
            echo "❌ Échec: aucun cache généré"
            # Créer un cache manuel minimal
            mkdir -p .sqlx
            echo '{"db":"SQLite","queries":{}}' > .sqlx/query.json
          fi
        
      - name: Push cache
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "github-actions"
          git add backend/.sqlx/
          if ! git diff --cached --quiet; then
            git commit -m "chore: update SQLx cache [skip ci]"
            git push
          fi