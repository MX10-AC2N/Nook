name: Generate SQLx Cache

on: workflow_dispatch

jobs:
  generate-cache:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        
      - name: Install correct SQLx CLI for 0.8
        run: |
          # sqlx 0.8 n√©cessite sqlx-cli depuis git
          cargo install --git https://github.com/launchbadge/sqlx --branch main sqlx-cli --no-default-features --features sqlite
          
      - name: Create database
        run: |
          cd backend
          mkdir -p data
          sqlite3 data/temp.db "VACUUM;"
          
      - name: Fix Cargo.toml dependencies
        run: |
          cd backend
          # Supprimer les contraintes de version qui causent des probl√®mes
          sed -i '/# üîí Fixes pour √©viter edition2024/,+2d' Cargo.toml
          echo "Cargo.toml apr√®s nettoyage:"
          cat Cargo.toml
          
      - name: Build and generate cache
        run: |
          cd backend
          # Nettoyer et construire d'abord
          cargo clean
          cargo update
          cargo build --features sqlite 2>&1 | tail -20
          DATABASE_URL="sqlite:data/temp.db" cargo sqlx prepare 2>&1 || echo "√âchec, cr√©ation manuelle..."
          
      - name: Create minimal cache
        run: |
          cd backend
          mkdir -p .sqlx
          echo '{"db":"SQLite","queries":{}}' > .sqlx/query.json
          echo "Cache minimal cr√©√©"
          
      - name: Commit
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add backend/.sqlx/ backend/Cargo.toml
          git commit -m "Add SQLx cache" || echo "Pas de changements"
          git push