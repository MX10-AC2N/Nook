name: Generate SQLx Cache

on:
  workflow_dispatch:  # Permet de lancer manuellement

jobs:
  prepare:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        
      - name: Install SQLx CLI
        run: cargo install sqlx-cli
        
      - name: Create SQLite database and run migrations
        run: |
          mkdir -p data
          # Vérifier que les migrations existent (pour débogage)
          ls -la backend/migrations/
          # Crée une base SQLite temporaire
          DATABASE_URL="sqlite:data/temp.db" sqlx database create
          # Exécute les migrations en spécifiant explicitement le dossier
          DATABASE_URL="sqlite:data/temp.db" sqlx migrate run --source ./backend/migrations
        
      - name: Generate SQLx offline cache
        run: |
          DATABASE_URL="sqlite:data/temp.db" cargo sqlx prepare --workspace -- --all-targets
        
      - name: Commit and push the cache
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
          git add .sqlx/
          git diff --staged --quiet || (git commit -m "chore: generate SQLx query cache" && git push)