name: CI – Build, Test & Publish Nook

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:          # déclenchement manuel

permissions:
  contents: read
  packages: write            # nécessaire pour pousser sur GHCR
  id-token: write           # OIDC si vous déployez sur un cloud

jobs:
  # --------------------------------------------------------------
  # 1️⃣ Préparation : checkout + caches
  # --------------------------------------------------------------
  prepare:
    runs-on: ubuntu-latest
    outputs:
      cargo-cache-key: ${{ steps.cargo-cache.outputs.cache-primary-key }}
      npm-cache-key:   ${{ steps.npm-cache.outputs.cache-primary-key }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0               # besoin de tout l'historique (tags)

      # --------- Cache Cargo ----------
      - name: Cache Cargo registry & target
        id: cargo-cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            backend/target
          key: cargo-${{ runner.os }}-${{ hashFiles('backend/Cargo.lock') }}
          restore-keys: |
            cargo-${{ runner.os }}-
  # --------------------------------------------------------------
  # 2️⃣ Build backend (Rust)
  # --------------------------------------------------------------
  build-backend:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout again
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions/setup-rust@v2
        with:
          rust-version: "1.83"

      - name: Build release binary
        working-directory: backend
        run: |
          cargo fetch               # utilise le cache
          cargo build --release

      - name: Upload backend binary as artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-binary
          path: backend/target/release/*   # ajuste le nom du binaire
  # --------------------------------------------------------------
  # 3️⃣ Build frontend (Node)
  # --------------------------------------------------------------
  build-frontend:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout again
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"               # cache interne npm (équiv. à actions/cache)

      - name: Install deps (npm ci)
        working-directory: frontend
        run: npm ci

      - name: Build production bundle
        working-directory: frontend
        run: npm run build

      - name: Upload built assets
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist/**

      # --------- Cache npm ----------
      - name: Cache npm modules
        id: npm-cache
        uses: actions/cache@v4
        with:
          path: frontend/node_modules
          key: npm-${{ runner.os }}-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            npm-${{ runner.os }}-
  # --------------------------------------------------------------
  # 4️⃣ Tests (parallèles)
  # --------------------------------------------------------------
  test:
    needs: [build-backend, build-frontend]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        component: [backend, frontend]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run backend tests
        if: matrix.component == 'backend'
        working-directory: backend
        run: cargo test --quiet

      - name: Run frontend tests
        if: matrix.component == 'frontend'
        working-directory: frontend
        run: |
          npm ci
          npm test
  # --------------------------------------------------------------
  # 5️⃣ Docker image (multi‑stage)
  # --------------------------------------------------------------
  docker-image:
    needs: [build-backend, build-frontend, test]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (again)
        uses: actions/checkout@v4

      # Récupère les artefacts produits précédemment
      - name: Download backend binary
        uses: actions/download-artifact@v4
        with:
          name: backend-binary
          path: backend/artifact

      - name: Download frontend dist
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend/artifact

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR (optional – needed only if you push)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & load Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          load: true                         # charge l’image dans le runner
          tags: |
            ghcr.io/${{ github.repository_owner }}/nook:${{ github.sha }}
            ghcr.io/${{ github.repository_owner }}/nook:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
