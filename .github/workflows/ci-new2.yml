name: CI

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - '**/*.md'
      - '**/*.txt'
      - '**/.gitignore'
      - '**/.dockerignore'
      - '**/README*'
  pull_request:
    branches: [main, develop]

env:
  CARGO_TERM_COLOR: always
  SQLX_OFFLINE: true
  DATABASE_URL: "sqlite:data/test.db"

jobs:
  setup_and_lockfiles:
    name: ðŸ”§ PrÃ©paration
    runs-on: ubuntu-latest
    
    outputs:
      cargo-lock-hash: ${{ steps.cargo-lock-hash.outputs.hash }}
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Installer Rust
        uses: dtolnay/rust-toolchain@stable

      - name: VÃ©rifier et gÃ©nÃ©rer Cargo.lock
        id: cargo-lock
        run: |
          if [ -d "backend" ]; then
            cd backend
            # VÃ©rifier si Cargo.lock existe
            if [ ! -f "Cargo.lock" ]; then
              echo "âš ï¸ Cargo.lock non trouvÃ©, gÃ©nÃ©ration..."
              cargo generate-lockfile
              echo "lock-generated=true" >> $GITHUB_OUTPUT
            else
              echo "âœ“ Cargo.lock prÃ©sent"
              echo "lock-generated=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âš ï¸ Dossier backend non trouvÃ©"
            echo "lock-generated=false" >> $GITHUB_OUTPUT
          fi

      - name: Calculer hash Cargo.lock
        id: cargo-lock-hash
        run: |
          if [ -f "backend/Cargo.lock" ]; then
            echo "Calcul du hash..."
            HASH=$(sha256sum backend/Cargo.lock | awk '{print $1}')
            echo "hash=${HASH}" >> $GITHUB_OUTPUT
          else
            echo "hash=none" >> $GITHUB_OUTPUT
          fi

  build_and_test:
    name: ðŸ—ï¸ Construction et Tests
    runs-on: ubuntu-latest
    needs: setup_and_lockfiles
    
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Installer Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: cargo-${{ runner.os }}-${{ hashFiles('backend/Cargo.lock') }}
          restore-keys: |
            cargo-${{ runner.os }}-

      - name: Installer les outils
        run: |
          # Installer uniquement si nÃ©cessaire
          which cargo-udeps > /dev/null || cargo install cargo-udeps --locked 2>/dev/null || true
          which cargo-audit > /dev/null || cargo install cargo-audit 2>/dev/null || true

      - name: VÃ©rifier les dÃ©pendances
        run: cargo fetch

      - name: PrÃ©parer environnement
        run: |
          mkdir -p data
          # CrÃ©er fichier DB pour tests
          touch data/test.db

      - name: Construction Debug
        run: cargo build

      - name: Construction Release
        run: cargo build --release

      - name: ExÃ©cuter les tests
        run: cargo test -- --nocapture

      - name: Tests de documentation
        run: cargo test --doc

  quality:
    name: ðŸ“‹ ContrÃ´le QualitÃ©
    runs-on: ubuntu-latest
    needs: [build_and_test]
    
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Installer Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: cargo-${{ runner.os }}-${{ hashFiles('backend/Cargo.lock') }}

      - name: Formatage
        run: cargo fmt --all -- --check

      - name: Lint avec Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: VÃ©rifier dÃ©pendances inutilisÃ©es
        run: |
          if command -v cargo-udeps &> /dev/null; then
            cargo udeps --all-targets || true
          else
            echo "cargo-udeps non installÃ©"
          fi

      - name: Audit sÃ©curitÃ©
        run: |
          if command -v cargo-audit &> /dev/null; then
            cargo audit || true
          else
            echo "cargo-audit non installÃ©"
          fi

  coverage:
    name: ðŸ“Š Couverture
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: [build_and_test]
    
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Installer Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Installer tarpaulin
        run: cargo install cargo-tarpaulin --locked

      - name: Calculer couverture
        run: cargo tarpaulin --out Xml

      - name: Upload rÃ©sultats
        uses: codecov/codecov-action@v3
        with:
          files: ./cobertura.xml
          fail_ci_if_error: false
