name: CI

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - '**/*.md'
      - '**/*.txt'
      - '**/.gitignore'
      - '**/.dockerignore'
      - '**/README*'
  pull_request:
    branches: [ main, develop ]

env:
  CARGO_TERM_COLOR: always
  SQLX_OFFLINE: true
  DATABASE_URL: "sqlite:data/test.db"

jobs:
  setup_and_lockfiles:
    name: üîß Pr√©paration et G√©n√©ration des Lockfiles
    runs-on: ubuntu-latest
    
    outputs:
      cargo-lock-hash: ${{ steps.cargo-lock-hash.outputs.hash }}
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Installer Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: V√©rifier et g√©n√©rer Cargo.lock
        id: cargo-lock
        run: |
          cd backend || echo "Dossier backend non trouv√©"
          
          # G√©n√©rer Cargo.lock s'il n'existe pas
          if [ ! -f "Cargo.lock" ]; then
            echo "‚ö†Ô∏è Cargo.lock non trouv√©, g√©n√©ration..."
            cargo generate-lockfile
            echo "lock-generated=true" >> $GITHUB_OUTPUT
          else
            echo "‚úì Cargo.lock pr√©sent"
            echo "lock-generated=false" >> $GITHUB_OUTPUT
          fi
          
          # V√©rifier si Cargo.lock est √† jour
          cargo update --dry-run || echo "Mise √† jour disponible"

      - name: Calculer hash Cargo.lock
        id: cargo-lock-hash
        run: |
          if [ -f "backend/Cargo.lock" ]; then
            hash=$(sha256sum backend/Cargo.lock | cut -d' ' -f1)
            echo "hash=$hash" >> $GITHUB_OUTPUT
          else
            echo "hash=no-lockfile" >> $GITHUB_OUTPUT
          fi

      - name: Commiter Cargo.lock g√©n√©r√© si nouveau
        if: steps.cargo-lock.outputs.lock-generated == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add backend/Cargo.lock
          git commit -m "ci: generate Cargo.lock" || echo "Aucun changement √† commiter"
          git push || echo "Push non n√©cessaire"

  build_and_test:
    name: üèóÔ∏è Construction et Tests Rust
    runs-on: ubuntu-latest
    needs: setup_and_lockfiles
    strategy:
      matrix:
        profile: [debug, release]
        rust: [stable]
    
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: Checkout avec lockfiles
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Installer Rust et outils
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ matrix.rust }}
          components: rustfmt, clippy
          targets: x86_64-unknown-linux-gnu

      - name: Installer outils suppl√©mentaires
        run: |
          cargo install cargo-udeps --locked || echo "cargo-udeps non install√©"
          cargo install cargo-audit || echo "cargo-audit non install√©"
          cargo install cargo-nextest || echo "cargo-nextest non install√©"

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ~/.cargo/bin
            target
          key: ${{ runner.os }}-cargo-${{ needs.setup_and_lockfiles.outputs.cargo-lock-hash }}-${{ matrix.rust }}
          restore-keys: |
            ${{ runner.os }}-cargo-${{ needs.setup_and_lockfiles.outputs.cargo-lock-hash }}
            ${{ runner.os }}-cargo-

      - name: Cache Rustup
        uses: actions/cache@v4
        with:
          path: ~/.rustup
          key: ${{ runner.os }}-rustup-${{ matrix.rust }}

      - name: V√©rifier les d√©pendances
        run: |
          cargo fetch --locked
          cargo --version
          rustc --version

      - name: Pr√©parer environnement de test
        run: |
          mkdir -p data
          touch data/test.db
          # Si vous utilisez des migrations SQLx
          if [ -f "migrations" ]; then
            cargo install sqlx-cli
            sqlx database create
            sqlx migrate run
          fi

      - name: V√©rification de compilation
        run: cargo check --all-targets --${{ matrix.profile }}

      - name: Construction
        run: cargo build --${{ matrix.profile }} --verbose

      - name: Tests unitaires (avec cargo-nextest si disponible)
        run: |
          if command -v cargo-nextest &> /dev/null; then
            cargo nextest run --profile=${{ matrix.profile }} --lib --tests
          else
            cargo test --${{ matrix.profile }} --lib --tests
          fi

      - name: Tests d'int√©gration
        run: cargo test --test '*'
        env:
          RUST_BACKTRACE: full
          RUST_LOG: debug

      - name: Tests de documentation
        run: cargo test --doc

  quality:
    name: üìã Contr√¥le Qualit√©
    runs-on: ubuntu-latest
    needs: [setup_and_lockfiles, build_and_test]
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Installer Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ needs.setup_and_lockfiles.outputs.cargo-lock-hash }}

      - name: V√©rification formatage
        run: cargo fmt --all -- --check

      - name: Analyse statique avec Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings -D clippy::all -D clippy::pedantic -D clippy::nursery -D clippy::cargo

      - name: V√©rifier les d√©pendances inutilis√©es
        run: cargo udeps --all-targets || echo "‚ö†Ô∏è cargo-udeps non disponible"

      - name: Audit de s√©curit√©
        run: cargo audit || echo "‚ö†Ô∏è Audit non disponible, v√©rifiez Cargo.lock manuellement"

      - name: V√©rifier les vuln√©rabilit√©s connues
        run: |
          cargo audit --deny warnings || echo "Aucune vuln√©rabilit√© critique"

      - name: V√©rifier la documentation
        run: cargo doc --no-deps --document-private-items

      - name: V√©rifier les licences
        run: |
          cargo install cargo-deny || echo "cargo-deny non install√©"
          cargo deny check || echo "V√©rification des licences ignor√©e"

  coverage:
    name: üìä Couverture de Code
    runs-on: ubuntu-latest
    needs: setup_and_lockfiles
    if: github.event_name == 'pull_request'
    
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Installer Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Installer tarpaulin
        run: cargo install cargo-tarpaulin

      - name: Couverture de code
        run: cargo tarpaulin --out Xml --engine llvm

      - name: Upload vers Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./cobertura.xml

notifications:
  on_success: change
  on_failure: always

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true